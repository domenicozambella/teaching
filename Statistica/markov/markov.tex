\documentclass[11pt,twoside,a4paper]{article}
\usepackage[italian]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[top=20mm, head=6mm, headsep=6mm, foot=6mm, bottom= 15mm, left=15mm, right=15mm]{geometry}
\usepackage{amsmath}
\usepackage{calc} 
\usepackage{pythontex}
\usepackage{tikz}
\usetikzlibrary{automata,positioning}
\newcommand{\mylabel}[1]{#1\hfill}
\renewenvironment{itemize}
  {\begin{list}{$\triangleright$}{%
   \setlength{\parskip}{0mm}
   \setlength{\topsep}{.4\baselineskip}
   \setlength{\rightmargin}{0mm}
   \setlength{\listparindent}{0mm}
   \setlength{\itemindent}{0mm}
   \setlength{\labelwidth}{2ex}
   \setlength{\itemsep}{.4\baselineskip}
   \setlength{\parsep}{0mm}
   \setlength{\partopsep}{0mm}
   \setlength{\labelsep}{1ex}
   \setlength{\leftmargin}{\labelwidth+\labelsep}
   \let\makelabel\mylabel}}{%
   \end{list}\vspace*{-1.3mm}}
\parindent0ex
\parskip2ex
\newcounter{quesito}
\newenvironment{question}{\bigskip\addtocounter{quesito}{1}\bigskip\bigskip\par\textbf{Quesito \thequesito.\kern0ex}}{\par\vspace{\parskip}}
\newenvironment{xquestion}{\bigskip\addtocounter{quesito}{1}\bigskip\bigskip\par\textbf{Quesito \thequesito.\kern1ex}}{\par\vspace{\parskip}}
\newenvironment{answer}{\par\textbf{Risposta\quad}}{\par\vspace{\parskip}}

\pagestyle{empty} 

\begin{document}
\colorbox{blue!10}{\begin{minipage}{\textwidth}
Esperimento con catene di Markov (senza definirle)

\end{minipage}}


\begin{pycode}
import random
random.seed(939399435)
ESAME = False
\end{pycode}


%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{question}
\def\Pr{{\rm Pr\,}}
\def\pyl#1{\py{latex(#1)}}
\everymath{\displaystyle}
\def\nicefrac#1#2{#1/#2}
\renewcommand{\arraystretch}{1.3}
\begin{pycode}
from sympy import *

while True :
    tp  =  random.sample( [1,2,3,4,5,6], 5 ) 
    pw, pz, wp, wz, zw = [Integer(i) for i in tp] 
    if pw+pz<=10 and wz+wz<=10 : break 
    
units = Integer( random.choice([5,10] ) )

while True :
    M = Matrix([ [100-pz-pw, wp,        0     ],
                 [pw,        100-wp-wz, zw    ],
                 [pz,        wz,        100-zw] ] )

    x0 = Matrix([ 0, units, 0 ] )

    d = (M/100).eigenvals()

    autovalori = dict( zip( [r'\lambda_1', r'\lambda_2', r'\lambda_3'], 
                           list(d.keys() ) ) )
    REAL = True
    for i, a in enumerate( list(d.keys() ) ):
        REAL = REAL and (0 == im(a))
    if REAL: break

p, w, z = symbols('p w z')


M1 = Rational(1,100)*M - eye(3)
M1 = M1.row_insert(3, Matrix([ [1, 1, 1] ] ) )
M1 = M1.col_insert(3, Matrix([0, 0, 0, units] ) )
equilibrio = solve_linear_system(M1, p,w,z)

\end{pycode}
Vogliamo modellare il trasferimento di nutrienti nella catena alimentare di un acquario. La catena alimentare consite di tre compartimenti: phytoplankton ({\sf P}), water ({\sf W}), zooplankton ({\sf Z}).

Dissolviamo $\py{units}$ unità del radioisotopo $^{14}C$. Qui sotto riassumiamo le percentuali di $^{14}C$ che ogni ora passano tra i compartimenti. Possiamo assumere che la concentrazione di radioisotopo nel sistema rimanga constante quindi gli isotopi che non vengono trasferiti rimangono nello stesso compartimento (nel grafico sono sottointese)

\hfil
\begin{tikzpicture}[font=\sffamily]
 
        % Setup the style for the states
        \tikzset{node style/.style={state, 
                                    minimum width=1.5cm,
                                    line width=0.5mm,
                                    fill=gray!20!white}}
 
        % Draw the states
        \node[node style] at (0, 0)     (P)     {P};
        \node[node style] at (6, 0)     (W)     {W};
        \node[node style] at (12, 0)    (Z)     {Z};
 
        % Connect the states with arrows
        \draw[every loop,
              auto=right,
              line width=0.5mm,
              >=latex]
            (P)     edge[bend right=20, auto=right]  node {$\py{pz}\%$} (Z)
            (P)     edge[bend right=5, auto=right]   node {$\py{pw}\%$} (W)
           %(W)     edge[bend right=30]              node {0.3} (P)
            (W)     edge[bend right=5, auto=right]   node {$\py{wz}\%$} (Z)
            (Z) edge[bend right=20]                  node {$\py{zw}\%$} (W)
            (W) edge[bend right=20, auto=right]      node {$\py{wp}\%$} (P);
\end{tikzpicture}




\begin{itemize}
\item[1.]  Scrivere la matrice $M$ che descrive l'evoluzione del processo $\vec x_{n+1}=M\vec x_{n}$ dove 
$\vec x_n\ =\ 
% \begin{bmatrix*}[l]
% p_n\\
% z_n\\
% w_n\\
% \end{bmatrix*}
[p_n,w_n,z_n]^{\rm T}$ dove $p_n$, $w_n$, e $z_n$ sono le quantità radioisotopo dopo $n$ ore nei rispettivi compartimenti.
\item[2.] Descrivere $\vec x_{0}$ lo stato iniziale del sistema descritto nel testo.
\item[3.] Calcolare $\vec x_{1}$
\item[4.] La matrice $M$ ha questo insieme di autovalori 

\hfil$\py{latex(autovalori)[8:-9 ].replace(':','=')}$.\medskip

Dire se partendo da $\vec x_0$ si raggiunge uno stato di equilibrio e nel caso calcolarlo.
\end{itemize}



\begin{answer}
\vskip-4ex
La matrice di transizione è {\color{blue}$M=\displaystyle\frac{1}{100}\pyl{M}$}\quad 
Lo stato iniziale è {\color{blue}$\vec x_{0}=\pyl{x0}$\hfill Risposte 1 e 2} 

{\color{blue}$\displaystyle\vec x_{1}\ =\ $}$M\,\vec x_{0}\ =\ \frac{1}{100}\pyl{M}\pyl{x0}\  =\ ${\color{blue}$\py{latex((M*x0)/100).replace('frac','nicefrac')}$\hfill Risposta 3} 

Notiamo che $|\lambda_2|, |\lambda_3|<|\lambda_1|=1$. Quindi la concentrazione tende all'autovettore corrispondente a $\lambda_1=1$. Possiamo calcolarlo risolvendo il sistema:

\hfil$M\,\big[p,\ w,\ z\big]^T = \,\big[p,\ w,\ z\big]^T$\qquad e\qquad $p+w+z=\py{units}$



{\color{blue}$p_\infty=\pyl{equilibrio[p]}$,\quad $w_\infty=\pyl{equilibrio[w]}$,\quad $z_\infty=\pyl{equilibrio[z]}$\hfill Risposta 4} 
\end{answer}
\end{question}




%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\begin{question}
\def\Pr{{\rm Pr\,}}
\def\pyl#1{\py{latex(#1) } }
\everymath{\displaystyle}
\def\nicefrac#1#2{#1/#2}
\renewcommand{\arraystretch}{1.3}
\begin{pycode}
from sympy import *
if not ESAME: random.seed(93393435)

while True :
    tp  =  random.sample( [1,2,3,4,5,6], 6 ) 
    ns, nv, sn, sv, vn, vs = [Integer(i) for i in tp] 
    if ns+nv<=10 and sn+sv<=10 and vn+vs<=10: break

while True :    
    M = Matrix([ [10-ns-nv, sn,        vn       ],
                [ns,         10-sn-sv, vs       ],
                [nv,         sv,        10-vn-vs] ] )

    x0 = Matrix([ 1, 0, 0 ] )

    d = (M/10).eigenvals()

    autovalori = dict( zip( [r'\lambda_1', r'\lambda_2', r'\lambda_3'], 
                           list(d.keys() ) ) )
    REAL = True
    for i, a in enumerate( list(d.keys() ) ):
        REAL = REAL and (0 == im(a))
    if REAL: break

n, s, v = symbols('n s v')

M1 = M - 10*eye(3)
M1 = M1.row_insert(3, Matrix([ [1, 1, 1] ] ) )
M1 = M1.col_insert(3, Matrix([0, 0, 0, 1] ) )
equilibrio = solve_linear_system(M1, n, s, v)

\end{pycode}
John’s Truck Rental does business in North Carolina ({\sf NC}), South Carolina ({\sf SC}) and Virginia ({\sf VA}). As with most rental agencies, customers may return the vehicle that they have rented at any of the company’s franchises throughout the three state area. In order to keep track of the movement of its vehicles, the company has accumulated data on the percentage of tracks rented one location that are  returned in a different location. The data are represented with the following diagram:

\hfil
\begin{tikzpicture}[font=\sffamily]
 
        % Setup the style for the states
        \tikzset{node style/.style={state, 
                                    minimum width=1.5cm,
                                    line width=0.5mm,
                                    fill=gray!20!white}}
 
        % Draw the states
        \node[node style] at (0, 0)     (N)     {NC};
        \node[node style] at (6, 0)     (S)     {SC};
        \node[node style] at (12, 0)    (V)     {VA};
 
        % Connect the states with arrows
        \draw[every loop,
              auto=right,
              line width=0.5mm,
              >=latex]
            (N) edge[bend right=20, auto=right]  node {$\py{10*nv}\%$} (V)
            (N) edge[bend right=7, auto=right]   node {$\py{10*ns}\%$} (S)
            (S) edge[bend right=7, auto=right]   node {$\py{10*sn}\%$} (N)
            (S) edge[bend right=7, auto=right]   node {$\py{10*sv}\%$} (V)
            (V) edge[bend right= 7, auto=right]  node {$\py{10*vs}\%$} (S)
            (V) edge[bend right=20, auto=right]  node {$\py{10*vn}\%$} (N);
\end{tikzpicture}


\begin{itemize}
\item[1.] If a truck is presently in North Carolina, what is the probability that it will again be in North Carolina after it has been rented twice? (Si usi un vettore $\vec x_{t} = [n_t,s_t,v_t]^{\rm T}$ per indicare la probabilità che dopo $t$ noleggi l'automezzo si trovi in ciascuno dei 3 stati indicati. Si scriva una matrice $M$ che  che descrive l'evoluzione delle probabilità $\vec x_{t+1}=M\vec x_{t}$)

\item[2.] What fraction of the life of a truck is spent in each of the three states? (La vita di un automezzo è sufficientemente lunga da poter assumere che trascorre tutto ilsuo tempo in condizioni di `steady-state'.)
\end{itemize}

\begin{answer}
\vskip-4ex
La matrice di transizione è $M=\displaystyle\frac{1}{10}\pyl{M}$. Lo stato iniziale è $\vec x_{0}=\pyl{x0}$ quindi 

$\displaystyle\vec x_{1}\ =\ M\,\vec x_{0}\ =\ \frac{1}{10}\pyl{M}\pyl{x0}\ =\ \frac{1}{10}\pyl{M*x0}$\hfil e\hfil $\displaystyle\vec x_{2}\ =\ M\,\vec x_{1}\ =\ \frac{1}{100}\pyl{M}\pyl{M*x0}\ =\ \py{latex( (M*M*x0)/100 ).replace('frac','nicefrac') }$

\medskip
{\color{blue}$n_2=\py{ ((M*M*x0)/100)[0] }$\hfill Risposta 1}

\medskip
La probabilità all'equilibrio la calcoliamo risolvendo il sistema:

\hfil$M\,\big[n,\ s,\ v\big]^T = \,\big[n,\ s,\ v\big]^T$\qquad e\qquad $n+s+v=1$



{\color{blue}$n_\infty=\pyl{equilibrio[n]}$,\quad $s_\infty=\pyl{equilibrio[s]}$,\quad $v_\infty=\pyl{equilibrio[v]}$\hfill Risposta 2} 
\end{answer}
\end{question}

\end{document}

