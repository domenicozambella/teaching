\documentclass[11pt,twoside,a4paper]{article}
\usepackage[italian]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[top=20mm, head=6mm, headsep=6mm, foot=6mm, bottom= 15mm, left=15mm, right=15mm]{geometry}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{calc} 
\usepackage{pythontex}
\usepackage{tikz}
\usetikzlibrary{automata,positioning}
\newcommand{\mylabel}[1]{#1\hfill}
\renewenvironment{itemize}
  {\begin{list}{$\triangleright$}{%
   \setlength{\parskip}{0mm}
   \setlength{\topsep}{.4\baselineskip}
   \setlength{\rightmargin}{0mm}
   \setlength{\listparindent}{0mm}
   \setlength{\itemindent}{0mm}
   \setlength{\labelwidth}{2ex}
   \setlength{\itemsep}{.4\baselineskip}
   \setlength{\parsep}{0mm}
   \setlength{\partopsep}{0mm}
   \setlength{\labelsep}{1ex}
   \setlength{\leftmargin}{\labelwidth+\labelsep}
   \let\makelabel\mylabel}}{%
   \end{list}\vspace*{-1.3mm}}
\parindent0ex
\parskip2ex
\newcounter{quesito}
\newenvironment{question}{\bigskip\addtocounter{quesito}{1}\bigskip\bigskip\par\textbf{Quesito \thequesito.\kern0ex}}{\par\vspace{\parskip}}
\newenvironment{xquestion}{\bigskip\addtocounter{quesito}{1}\bigskip\bigskip\par\textbf{Quesito \thequesito.\kern1ex}}{\par\vspace{\parskip}}
\newenvironment{answer}{\par\textbf{Risposta\quad}}{\par\vspace{\parskip}}

\pagestyle{empty} 

\begin{document}
\colorbox{blue!10}{\begin{minipage}{\textwidth}
Esperimento con HMM (senza definirli)

\end{minipage}}

\bigskip\bigskip


\begin{pycode}
import random
random.seed(29499935)
\end{pycode}


%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
% \begin{question}
% \def\Pr{{\rm Pr\,}}
% \def\pyl#1{\py{latex(#1)}}
% \everymath{\displaystyle}
% \renewcommand{\arraystretch}{2}
% \begin{pycode}
% from sympy import *
% p = random.sample([2, 3, 4, 5, 6, 7, 8], 4)
% pab = Rational(p[0],10)
% pba = Rational(p[1],10)
% paa = 1 - pab
% pbb = 1 - pba
% P = Matrix(( (paa, pba), 
%              (pba, pbb) ))
% M = Matrix(( (paa-1, pba, 0),
%              (1,     1,   1) ))
% x = Symbol('x')
% y = Symbol('y')
% equilibrio = solve_linear_system(M, x, y)
% 
% 
% 
% A1= Rational(p[2],10)
% B1= Rational(p[3],10)
% \end{pycode}
% Consideriamo un cammino aleatorio tra due stati {\sf a} e {\sf b}. Quando siamo nello stato {\sf a} lanciamo una moneta con probabilità di successo $q_{\sf a}=\py{A1}$ quando siamo in {\sf b} lanciamo una moneta con probablilità di successo $q_{\sf b}=\py{B1}$. Noi osserviamo solo il risultato del lancio e non abbiamo informazioni sullo stato. Possiamo però assumere che la distribuzione sugli stati siano in equilibrio (steady state). 
% 
% %Modelliamo il lancio di due monete che modelliamo con le v.a.\@ $A,B\in\{0,1\}$. Quando siamo nello stato {\sf a} laciamo la moneta $A$ che ha probablilità di successo $q_{\sf a}=\py{A1}$ quando siamo in {\sf b} lanciamo $B$ che ha probablilità di successo $q_{\sf b}=\py{B1}$.  
% 
% \hfil
% %\begin{minipage}[t]{0.45\textwidth}
% \begin{tikzpicture}[baseline=2ex]
%     % Draw the states
%     \node[state]             (a) {{\sf a}};
%     \node[state, right=of a] (b) {{\sf b}};
%  
%     % Connect the states with arrows
%     \draw[every loop]
%         (a) edge[bend right, auto=right] node {\py{pab}} (b)
%         (b) edge[bend right, auto=right] node {\py{pba}} (a);
% \end{tikzpicture}
% %\end{minipage}
% \hfil
% \begin{minipage}[t]{40ex}
% $q_{\sf a}\ =\ \Pr(A=1)\ =\ \py{A1}$
% \\[2ex] 
% $q_{\sf b}\ =\ \Pr(B=1)\ =\ \py{B1}$
% \end{minipage}
% 
% 
% 
% \begin{itemize}
% \item[1.] Supponiamo di osservare $1$, qual è la probabilità il processo si trovi nello stato {\sf a}.
% \item[2.] Supponiamo di osservare $01$ in due istanti successivi qual è la probabilità che il processo si trovi in entrambi gli istanti nello stato {\sf a}.
% \end{itemize}
% 
% 
% 
% \begin{answer}
% 
% La matrice di transizione è $P=\displaystyle\pyl{P}$ la distribuzione di equilibrio è $\pi_{\sf a}=\py{equilibrio[x]}$,  $\pi_{\sf b}=\py{equilibrio[y]}$ 
% 
% $\Pr(X_0=1 | S_0={\sf a})$
% 
% {\color{blue}\hfill Risposta 1} 
% 
% {\color{blue}\hfill Risposta 2} 
% \end{answer}
% \end{question}






%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{question}%11111111111111111111
\def\Pr{{\rm Pr\,}}
\def\pyl#1{\py{latex(#1)}}
\def\nicefrac#1#2{#1/#2}
\everymath{\displaystyle}
\renewcommand{\arraystretch}{1.3}
\begin{pycode}
from sympy import *
d =  random.sample([4,5], 2) 
pab, pba = random.sample( range( 2,d[0] ), 2 )
pab = Integer( pab )
pba = Integer( pba )
paa = d[0] - pab
pbb = d[0] - pba
P  = Matrix([ [paa, pba], 
              [pab, pbb] ])
        

pa0 = Integer( random.choice( [0,1] ) ) 
S0  = Matrix([ pa0, 1-pa0 ] ) 
if pa0==1: inizio='a' 
else: inizio='b' 

qa, qb = random.sample( range( 2,d[1] ), 2 ) 
qa = Rational( qa, d[1] ) 
qb = Rational( qb, d[1] ) 
d = [Integer(i) for i in d]
px2 = qa*(P*P*S0)[0] + qb*(P*P*S0)[1]


\end{pycode}
Consideriamo il percorso aleatorio descritto in figura. Nello stato {\sf a} viene lanciata una moneta a valori {\sf T} o {\sf C}. La probabilità che esca {\sf T} è $\py{qa}$. Nello stato {\sf b} viene lanciata una moneta con probabilità $\py{qb}$ che esca {\sf T}.

\hfil
\begin{tikzpicture}[baseline=0ex]
    % Draw the states
    \node[state,fill=gray!30]             (a) {{\sf a}};
    \node[state,fill=gray!30, right=3 of a] (b) {{\sf b}};
 
    % Connect the states with arrows
    \draw[every loop]
        (a) edge[bend right, line width=1pt, auto=right] node {\py{pab/d[0]}} (b)
        (b) edge[bend right, line width=1pt, auto=right] node {\py{pba/d[0]}} (a);
\end{tikzpicture}
\hfil Le transizioni {\sf aa} e {\sf bb} sono implicite.

Il percorso comincia (al tempo $t{=}0$) dallo stato {\sf \py{inizio}}. Al tempo $t=2$ il risultato del lancio della moneta è {\sf T}. Qual è la probabilità che il processo al tempo $t{=}2$ si trovi nello stato {\sf a}~?


Indichiamo con $S_t\in\{{\sf a}, {\sf b}\}$ le variabili aleatorie che danno lo stato al tempo $t$. Indichiamo con $X_t\in\{{\sf T}, {\sf C}\}$ le variabili aleatorie che danno il risultato del lancio al tempo $t$. Si esprima usando queste v.a.\@ la probabilità condizionata che si intende calcolare. 

Esprimere i risultati numerici come frazioni di interi.


\begin{answer}

Dalla figura inferiamo la matrice di transizione $P=\pyl{1/d[0]}\pyl{P}$. 

Il testo riporta le seguenti probabilità:

$\Pr\big(S_0={\sf  \py{inizio}}\big)=1$\hfill e per ogni $t$:\quad  $\Pr\big(X_t={\sf T}~|~S_t={\sf a}\big)=\pyl{qa}$,\hfill $\Pr\big(X_t={\sf T}~|~S_t={\sf b}\big)=\pyl{qb}$
\bigskip


$\begin{bmatrix}\Pr(S_1={\sf a})\\\Pr(S_1={\sf b})\end{bmatrix}
\ =\ 
P\begin{bmatrix}\Pr(S_0={\sf a})\\\Pr(S_0={\sf b})\end{bmatrix}
\ =\ 
\pyl{1/d[0]}\pyl{P*S0}$
\hfil
$\begin{bmatrix}\Pr(S_2={\sf a})\\\Pr(S_2={\sf b})\end{bmatrix}
\ =\ 
P\begin{bmatrix}\Pr(S_1={\sf a})\\\Pr(S_1={\sf b})\end{bmatrix}
\ =\  
\pyl{1/d[0]**2}\pyl{P*P*S0}$

\medskip
$\Pr\big(X_2={\sf T}\big)\ =\ \Pr\big(X_2={\sf T}~|~S_2={\sf a}\big)\cdot\Pr\big(S_2={\sf a}\big) \ + \ \Pr\big(X_2={\sf T}~|~S_2={\sf b}\big)\cdot\Pr\big(S_2={\sf b}\big)$
\\[2ex]
$\phantom{\Pr\big(X_2={\sf T}\big)}\ =\ \pyl{qa}\cdot\pyl{(P*P*S0)[0]/d[0]**2} \ + \ \pyl{qb}\cdot\pyl{(P*P*S0)[1]/d[0]**2}\ =\ \pyl{px2/d[0]**2}$

\bigskip
{\color{blue}$\Pr(S_2={\sf a}~|~X_2={\sf T})$}$\ =\ \frac{\Pr(X_2={\sf T}~|~S_2={\sf a})\cdot\Pr(S_2={\sf a})}{\Pr(X_2={\sf T})}${\color{blue}$\ =\ \pyl{qa*(P*P*S0)[0]/px2}$\hfill Risposta} 
\end{answer}
\end{question}


%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\begin{question}%22222222222222222
\def\Pr{{\rm Pr\,}}
\def\nicefrac#1#2{#1/#2}
\def\pyl#1{\py{latex(#1)}}
\everymath{\displaystyle}
\renewcommand{\arraystretch}{1.5}
\begin{pycode}
from sympy import *
d =  random.sample([4,5], 2) 
pab, pba = random.sample( range( 2,d[0] ), 2 )
pab = Integer( pab )
pba = Integer( pba )
paa = d[0] - pab
pbb = d[0] - pba
P  = Matrix([ [paa, pba], 
              [pab, pbb] ])

pa0 = Integer( random.choice( [0,1] ) ) 
S0  = Matrix([ pa0, 1-pa0 ] ) 
if pa0==1: inizio='a' 
else: inizio='b' 

qa, qb = random.sample( range( 2,d[1] ), 2 ) 
qa = Rational( qa, d[1] ) 
qb = Rational( qb, d[1] ) 
d = [Integer(i) for i in d]
px2 = qa*(P*P*S0)[0] + qb*(P*P*S0)[1]

ptt = ( (P*S0)[0]*paa/d[0]**2 ) * qa*qa
+ ( (P*S0)[0]*pab/d[0]**2 ) * qa*qb
+ ( (P*S0)[1]*pbb/d[0]**2 ) * qb*qb
+ ( (P*S0)[1]*pba/d[0]**2 ) * qb*qa
\end{pycode}
Consideriamo il percorso aleatorio descritto in figura. Quando il processo si trova nello stato {\sf a} viene lanciata una moneta a valori {\sf T} o {\sf C}. La probabilità che esca {\sf T} è $\py{qa}$. Nello stato {\sf b} viene lanciata una moneta con probabilità $\py{qb}$ che esca {\sf T}.

\hfil
\begin{tikzpicture}[baseline=0ex]
    % Draw the states
    \node[state,fill=gray!30]             (a) {{\sf a}};
    \node[state,fill=gray!30, right=3 of a] (b) {{\sf b}};
 
    % Connect the states with arrows
    \draw[every loop]
        (a) edge[bend right, line width=1pt, auto=right] node {\py{pab/d[0]}} (b)
        (b) edge[bend right, line width=1pt, auto=right] node {\py{pba/d[0]}} (a);
\end{tikzpicture}
\hfil Le transizioni {\sf aa} e {\sf bb} sono implicite.

Il percorso comincia (al tempo $t{=}0$) dallo stato {\sf \py{inizio}}. Al tempo $1$ e $2$ il risultato del lancio della moneta è {\sf TT}. Qual è la probabilità che gli stati corrispondenti siano {\sf ab}~?

Esprimere i risultati numerici come frazioni di interi.

Per sveltire la soluzione calcoliamo le seguenti probabilità. Indichiamo con $S_t\in\{{\sf a}, {\sf b}\}$ le variabili aleatorie che danno lo stato al tempo $t$. Indichiamo con $X_t\in\{{\sf T}, {\sf C}\}$ le variabili aleatorie che danno il risultato del lancio al tempo $t$. Per leggibilità nelle segienti abbiamo omesso di scrivere $X_1X_2=$ e $S_1S_2=$.

$\begin{matrix*}[l]
\Pr({\sf TT}\ |\ {\sf aa})
\ =\ \pyl{ qa*qa}
\ \ & \ \ 
\Pr({\sf TT}\ |\ {\sf ab})
\ =\ \ ?
\\[2ex]
\Pr({\sf TT}\ |\ {\sf ba})
\ =\ \pyl{ qa*qb}
\ \ & \ \ 
\Pr({\sf TT}\ |\ {\sf bb})
\ =\ \pyl{ qb*qb}
\end{matrix*}$
\hfill
$\begin{matrix*}[l]
\Pr({\sf aa})
\ =\ \pyl{(P*S0)[0]*paa/d[0]**2}
\ \ & \ \ 
\Pr({\sf ab})
\ =\ \ ?
\\[2ex]
\Pr({\sf ba})
\ =\ \pyl{(P*S0)[1]*pba/d[0]**2}
\ \ & \ \ 
\Pr({\sf bb})
\ =\ \pyl{(P*S0)[1]*pbb/d[0]**2}
\end{matrix*}$
\begin{answer}

Il testo riporta le seguenti probabilità:

$\Pr\big(S_0={\sf \py{inizio}}\big)=1$\hfill e per ogni $t$\hfill  $\Pr\big(X_t={\sf T}~|~S_t={\sf a}\big)=\pyl{qa}$,\hfill $\Pr\big(X_t={\sf T}~|~S_t={\sf b}\big)=\pyl{qb}$
\smallskip

$\Pr(X_1X_2={\sf TT}\ |\ S_1S_2={\sf ab})
\ =\ \Pr(X_1={\sf T}\, |\, S_1= {\sf a})\cdot\Pr(X_2={\sf T}\, |\,S_2= {\sf b})
\ =\ \pyl{qa}\cdot\pyl{qb}
\ =\ \pyl{qa*qb}$

Dalla figura inferiamo la matrice di transizione $P=\pyl{1/d[0]}\pyl{P}$, \ quindi\hfill  
$\begin{bmatrix}\Pr(S_1={\sf a})\\\Pr(S_1={\sf b})\end{bmatrix}=P\pyl{S0}=\pyl{1/d[0]}\pyl{P*S0}$
\hfil
%$\begin{bmatrix}\Pr(S_2={\sf a})\\\Pr(S_2={\sf b})\end{bmatrix}=P^2\pyl{S0}= \pyl{1/d[0]}\,P\pyl{P*S0} =\pyl{1/d[0]**2}\pyl{P*P*S0}$
\smallskip

$\Pr(S_1S_2={\sf ab})
\ =\ 
\Pr(S_1={\sf a})\cdot\Pr(S_2={\sf b}\ |\ S_1={\sf a})
\ =\ 
\pyl{(P*S0)[0]/d[0]}\cdot \pyl{pab/d[0]}
\ =\ 
\pyl{(P*S0)[0]*pab/d[0]**2}$


Nelle seguenti omettiamo di scrivere $X_1X_2=$ e $S_1S_2=$

$\Pr({\sf TT})
\ =\ \sum_{i,j\in\{{\sf a},{\sf b}\}} \Pr(ij)\cdot\Pr({\sf TT}\,|\,ij)$

$\phantom{\Pr({\sf TT})}
\ =\ \Pr({\sf aa})\cdot\Pr({\sf TT}\, |\, {\sf aa})
\ +\ \Pr({\sf ab})\cdot\Pr({\sf TT}\, |\, {\sf ab})
\ +\ \Pr({\sf bb})\cdot\Pr({\sf TT}\, |\, {\sf bb})
\ +\ \Pr({\sf ba})\cdot\Pr({\sf TT}\, |\, {\sf ba})$

$\phantom{\Pr({\sf TT})}
\ =\ \pyl{(P*S0)[0]*paa/d[0]**2}\cdot\pyl{qa*qa}
\ +\ \pyl{(P*S0)[0]*pab/d[0]**2}\cdot\pyl{qa*qb}
\ +\ \pyl{(P*S0)[1]*pbb/d[0]**2}\cdot\pyl{qb*qb}
\ +\ \pyl{(P*S0)[1]*pba/d[0]**2}\cdot\pyl{qb*qa}
\ =\ \pyl{ ptt }$
\bigskip
         
         

{\color{blue}$\Pr({\sf ab}\, |\, {\sf TT})$}
$\ =\ 
\frac{\Pr({\sf TT}\,|\,{\sf ab})\cdot\Pr({\sf ab})}{\Pr({\sf TT})}
\ =\ \frac{(\py{qa*qb} )\cdot (\py{(P*S0)[0]*pab/d[0]**2}) }{\py{ptt}}$
{\color{blue}
$\ =\ \pyl{ qa*qb*(P*S0)[0]*pab/(ptt*d[0]**2)}$
\hfill Risposta}
\end{answer}



\end{question}


\end{document}

